<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CriSim</title>
<style>
body { font-family: sans-serif; background: #e0f0ff; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
header { background: #0077cc; color: white; padding: 15px; text-align: center; }
#controls { background: #e9f3ff; text-align: center; padding: 10px; }
#controls button { padding: 10px 20px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; }
#startBtn { background: #28a745; color: white; }
#startBtn:hover { background: #218838; }
#refreshBtn { background: #dc3545; color: white; display: none; }
#refreshBtn:hover { background: #c82333; }
#chat { flex: 1; max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
#messages { flex: 1; overflow-y: auto; margin-bottom: 15px; }
.msg { margin: 12px 0; }
.user { font-weight: bold; color: #0077cc; }
.bot { font-weight: bold; color: #cc5500; }
.bot-msg, .user-msg { white-space: pre-wrap; }
#choices { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
.choice-btn { padding: 10px; border-radius: 8px; border: none; background: #0077cc; color: white; cursor: pointer; font-size: 1em; }
.choice-btn:hover { background: #005fa3; }
#customInputContainer { display: flex; gap: 10px; margin-top: 10px; }
#customInput { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
#sendCustom { padding: 10px 20px; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; font-size: 1em; }
#sendCustom:hover { background: #218838; }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<header>
  <h1>CriSim</h1>
  <p style="margin: 8px 0 0; font-size: 1.1em;">An interactive school crisis simulator for training and preparedness.</p>
</header>

<div id="controls">
<button id="startBtn" onclick="startScenario()">Start Scenario</button>
<button id="refreshBtn" onclick="refreshScenario()">Refresh</button>
</div>

<div id="chat">
<div id="messages"></div>
<div id="choices" style="display: none;"></div>
<div id="customInputContainer" style="display: none;">
    <input type="text" id="customInput" placeholder="Type your custom response here...">
    <button id="sendCustom">Send</button>
</div>
</div>

<script>
const API_URL = "https://openrouter.ai/api/v1/chat/completions";
const API_KEY = "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";

const scenarioPrompt = `
Act as a roleplay chatbot for CriSim, a school crisis simulator. At random intervals, simulate a realistic school emergency scenario... (your entire original scenario rules stay here)
`;

let runningContext = [{ role: "system", content: scenarioPrompt }];

const messagesDiv = document.getElementById("messages");
const choicesDiv = document.getElementById("choices");
const customInputContainer = document.getElementById("customInputContainer");
const customInput = document.getElementById("customInput");

function appendMessage(sender, text, isBot = false) {
    const div = document.createElement("div");
    div.classList.add("msg");
    div.innerHTML = `<span class="${isBot ? 'bot' : 'user'}">${sender}:</span> <div class="${isBot ? 'bot-msg' : 'user-msg'}">${marked.parse(text)}</div>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function displayChoices(options) {
    choicesDiv.innerHTML = "";
    choicesDiv.style.display = "flex";
    options.forEach(option => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.innerText = option;
        btn.onclick = () => handleChoice(option);
        choicesDiv.appendChild(btn);
    });
    customInputContainer.style.display = "flex";
}

async function handleChoice(choiceText) {
    appendMessage("You", choiceText, false);
    runningContext.push({ role: "user", content: choiceText });
    choicesDiv.style.display = "none";
    customInputContainer.style.display = "none";
    await sendToBot();
}

async function startScenario() {
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("refreshBtn").style.display = "inline-block";
    messagesDiv.innerHTML = "";
    appendMessage("System", "Starting scenario...", true);
    runningContext = [{ role: "system", content: scenarioPrompt }];
    await sendToBot();
}

function refreshScenario() {
    document.getElementById("startBtn").style.display = "inline-block";
    document.getElementById("refreshBtn").style.display = "none";
    messagesDiv.innerHTML = "";
    appendMessage("System", "Scenario reset. Click 'Start Scenario' to begin again.", true);
    runningContext = [];
}

async function sendToBot() {
    const response = await fetch(API_URL, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ 
            model: "mistralai/mixtral-8x7b-instruct",
            messages: runningContext,
            max_tokens: 500 
        })
    });
    const data = await response.json();
    const botReply = data.choices?.[0]?.message?.content || "(no response)";
    appendMessage("CriSim", botReply, true);
    runningContext.push({ role: "assistant", content: botReply });

    const choiceLines = botReply.split("\n").filter(line => /^\d+\.\s/.test(line.trim()));
    if (choiceLines.length > 0) displayChoices(choiceLines.map(line => line.replace(/^\d+\.\s*/, '').trim()));
}
</script>
</body>
</html>
